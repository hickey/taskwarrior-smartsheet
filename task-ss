#!/usr/bin/env python

import os,sys,re
import argparse
import logging

from taskw import TaskWarrior
from smartsheet import *


# Constants
CONF_FILE = os.getenv('TASK_SS_CONF') or '~/.task/smartsheet.conf'


class ConfigStore:
    
    def __init__(self, conf_file=CONF_FILE):
        """ConfigStore(conf_file=CONF_FILE): object
        Read in the configuration file for locating API keys to connect to the
        Smartsheet API. The config file location can be controlled externally 
        by setting the environmental variable TASK_SS_CONF to the config file
        location. Environmental variables and tilde (~) can be used to specify 
        the file location. All parent directories must exist, but the file will
        be created if it does not exist."""
        
        self.config = {'key':{}, 'proj':{}, }
        self.conf_file = os.path.expandvars( 
                         os.path.expanduser(conf_file))
        
        # expand conf_dir and test if we can proceed
        conf_dir = os.path.dirname(self.conf_file)
        if not os.path.exists(conf_dir):
            raise RuntimeError('Parent directory does not exist: ', conf_dir)
        elif not os.path.isdir(conf_dir):
            raise RuntimeError('Parent is not a directory: ', conf_dir)
        
        # Stream in the config file if it exists
        self._load_config(self.conf_file)
        
    
    def add_key(self, key, sheet_id='0'):
        """add_key(key, sheet_id=0)
        Add an API key to the Keystore object. If the sheet_id is not 
        specified, then the default key will be used."""
        
        self._set('key', sheet_id, key)
        
        
    def del_key(self, key=None, sheet_id=None):
        """del_key(key=None, sheet_id=None)
        Remove an API key from the Keystore object. Either the key or the
        sheet_id may be specified to locate the key to remove."""
        
        if sheet_id:
            self._del('key', sheet_id)
        elif key:
            for id,api_key in self.config['key'].items():
                if api_key == key:
                    self._del('key', id)
        else:
            raise RuntimeError('API key nor sheet ID specified for del_key')
    
    def default_key(self):
        if self.config['key'].has_key('0'):
            return self.config['key']['0']
        else:
            raise RuntimeError('Default API key not defined') 

    def save(self):
        """save()
        Take all existing keys in the Keystore object to the config file."""

        self._save_config()
        

    def _set(self, type, key, val):
        self.config[type][key] = val
        
    def _get(self, type, key):
        return self.config[type][key]
        
    def _del(self, type, key):
        if self.config[type].has_key(key):
            self.config[type][key].delete
    
    def _load_config(self, conf_file):
        data = {}
        if os.path.exists(conf_file):
            with open(conf_file, 'r') as fh:
                for line in fh.readlines():
                    if line.startswith('key;'):
                        id,key = line.rstrip('\n').replace('key;','').split(':')
                        self._set('key', id, key)
                    elif line.startswith('proj;'):
                        id,name = line.rstrip('\n').replace('proj;','').split(':')
                        self._set('proj', id, name)
                        
                        
    def _save_config(self):
        with open(self.conf_file, 'w') as fh:
            for sheet_id, key in self.config['key'].items():
                fh.write("key;{0}:{1}\n".format(sheet_id, key))
            for sheet_id, key in self.config['proj'].items():
                fh.write("proj;{0}:{1}\n".format(sheet_id, key))
                

class SheetAPI:
    
    def __init__(self, keystore=None):
        
        if not keystore:
            raise RuntimeError('SheetsAPI needs reference to the keystore')
        self.keystore = keystore
        
        self.service = smartsheet.Smartsheet(self.keystore.default_key())

        
    def list_sheets(self, filter=None):
        """list_sheets(filter=None): Dict
        Connect to the Smartsheet API and request a list of sheets for the given
        filter. If not filter is specified (empty string or None) then all
        sheets will be requested. """
    
        sheets = {}
        for sheet in self.service.Sheets.list_sheets(include_all=True).data:
            match = True
            for text in filter:
                if text.startswith('!'):
                    # negative match (term found, deny match)
                    if re.search(text[1:], sheet.name, re.I):
                        match = False
                else:
                    # positive match (term found, allow match)
                    if not re.search(text, sheet.name, re.I):
                        match = False
                    
            if match:
                sheets[sheet.id] = sheet.name

        return sheets


if __name__ == '__main__':
    
    # Proceess command line args
    parser = argparse.ArgumentParser(description='Taskwarrior to Smartsheet Sync')

    parser.add_argument('--list', '-l', default=None, type=str, nargs='*',
                        metavar='SEARCH_TEXT', 
                        help='List available Smartsheets')
    parser.add_argument('--sheet', '-s', default=None, type=int, metavar='ID',
                        help='Smartsheet ID to setup a sync for')
    parser.add_argument('--key', '-k', default=None, type=str, 
                        metavar='API_KEY',
                        help='Specify API key to access sheets')
    parser.add_argument('--project', '-P', default=None, type=str,
                        metavar='NAME',
                        help='Taskwarrior project to associate with sheet')
    parser.add_argument('--default-key', '-K', default=None, type=str,
                        metavar='API_KEY',
                        help='Set default Smartsheet API key')
    parser.add_argument('--config', '-f', default=CONF_FILE, type=str, 
                        metavar='FILE',
                        help='Read specified config file for API keys')
    parser.add_argument('command', type=str, nargs='?',
                        choices=['add', 'delete', 'modify', 'sync'])
    
    
    args = parser.parse_args()
    
    
    #logging.basicConfig()
    #logging.getLogger().setLevel(logging.DEBUG)
    #requests_log = logging.getLogger("requests.packages.urllib3")
    #requests_log.setLevel(logging.DEBUG)
    #requests_log.propagate = True
    
    
    # load the configs for connecting to Smartsheet API
    config = ConfigStore(args.config)
    try:
        if config.default_key():
            api = SheetAPI(config)
    except RuntimeError:
        if not args.default_key:
            print('Default API key has not yet been set.')
        api = None
    
    
    ## Save a default key for future use
    if args.default_key:
        config.add_key(args.default_key)
        config.save()
    
    ## Display a list of sheets available to sync
    elif args.list is not None and api is not None:
        sheets = api.list_sheets(filter=args.list)
        for id,name in sheets.items():
            print('%22d : %s' % (id, name))
        
    ## Check for a command
    elif args.command:
        if args.command == 'add':
            print "add"
    